<!DOCTYPE html>  <html> <head>   <title>nudgs.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               nudgs.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This demo takes a file on your hard drive and gives you a public facing url 
that can be used to access it. You will be able to access it from anywhere, 
anytime, as long as your computer is connected to the internet 
(solves the nat problem with the bittorrent "falcon" proxy which torrent 
clients can be configured to connect to).</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Nudge Item View</h2>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nb">window</span><span class="p">.</span><span class="nx">NudgeView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
		<span class="nx">tagName</span><span class="o">:</span>  <span class="s2">&quot;li&quot;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Cache the template function for a single item.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">template</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#item-template&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">()),</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The DOM events specific to an item.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
			<span class="s2">&quot;click span.nudge-destroy&quot;</span>   <span class="o">:</span> <span class="s2">&quot;clear&quot;</span>
		<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>The NudgeView listens for changes to its model, re-rendering.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;clear&#39;</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
		<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Re-render the contents of the nudge item.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>we generate the falcon urls from information gleen</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">parameters</span> <span class="o">=</span> <span class="nx">get_url_parameters</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;streaming_url&#39;</span><span class="p">));</span>
			<span class="kd">var</span> <span class="nx">clientid</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">btapp</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;settings&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;remote_client_id&#39;</span><span class="p">);</span>
			<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;https://remote-staging.utorrent.com/talon/seed/&#39;</span> <span class="o">+</span> <span class="nx">clientid</span> <span class="o">+</span> <span class="s1">&#39;/content/&#39;</span> <span class="o">+</span> <span class="nx">parameters</span><span class="p">[</span><span class="s1">&#39;sid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>we want to avoid showing the path of the files...just strip it down to the file name</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^.*[\\\/]/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
			
			<span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()));</span>
			<span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="s1">&#39;&lt;div&gt;&lt;a target=&quot;_blank&quot; title=&quot;&#39;</span> <span class="o">+</span> <span class="nx">url</span> <span class="o">+</span> <span class="s1">&#39;&quot; href=&quot;&#39;</span> <span class="o">+</span> <span class="nx">url</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;&lt;/a&gt;&#39;</span> <span class="o">+</span> <span class="nx">tweetShare</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="o">+</span> <span class="nx">fbShare</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/div&gt;&#39;</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.nudge-text&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
			<span class="k">return</span> <span class="k">this</span><span class="p">;</span>
		<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Tell the torrent to remove itself...when this change has occured in the torrent
client it will bubble back to the backbone library...however this could take a second
or two and conflict with the user's expectations...so we'll assume that the torrent remove
call will be successful and pre-emptively remove the view</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">torrents</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">btapp</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">).</span><span class="nx">at</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;torrent&#39;</span><span class="p">);</span>
			<span class="kd">var</span> <span class="nx">torrent</span> <span class="o">=</span> <span class="nx">torrents</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;btapp/label/all/nudges/torrent/all/&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;torrent&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
			<span class="nx">torrent</span><span class="p">.</span><span class="nx">bt</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{});</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h2>Btapp Initialization</h2>

<p>We're very specific in the filtering for this app, as we're only interested in torrents
with the nudge label, and a smattering of other functionality, related to torrent creation
and falcon setup/connections</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nb">window</span><span class="p">.</span><span class="nx">btapp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Btapp</span><span class="p">({</span>
		<span class="cm">/**</span>
<span class="cm">		&#39;username&#39;: &#39;patrick&#39;,</span>
<span class="cm">		&#39;password&#39;: &#39;password&#39;,</span>
<span class="cm">		**/</span>
		<span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;btapp&#39;</span><span class="p">,</span>
		<span class="s1">&#39;url&#39;</span><span class="o">:</span> <span class="s1">&#39;btapp/&#39;</span><span class="p">,</span>
		<span class="s1">&#39;queries&#39;</span><span class="o">:</span> <span class="p">[</span>
			<span class="s1">&#39;btapp/label/all/nudges/torrent/all/*/file/all/*/&#39;</span><span class="p">,</span>
			<span class="s1">&#39;btapp/label/all/nudges/torrent/all/*/remove/&#39;</span><span class="p">,</span>
			<span class="s1">&#39;btapp/create/&#39;</span><span class="p">,</span>
			<span class="s1">&#39;btapp/browseforfiles/&#39;</span><span class="p">,</span>
			<span class="s1">&#39;btapp/settings/&#39;</span><span class="p">,</span>
			<span class="s1">&#39;btapp/connect_remote/&#39;</span>
		<span class="p">]</span>
	<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h2>BtappListener Initialization</h2>

<p>The Btapp data tree is quite deep, and its a pain to add listeners to each model/collection
as they are added from the torrent client...Instead we can use the BtappListener to bind
to the creation of certain types of models...in this case all the files in all the torrents
that have the "nudges" label. </p>

<p>This has proven to be the most convenient way to interact with the btapp object,
as it greatly simplifies the task of waiting for specific types of models (I assume most
apps will be most interested in listening for all files in all torrents the same way 
this is done).</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">listener</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BtappListener</span><span class="p">({</span><span class="s1">&#39;btapp&#39;</span><span class="o">:</span> <span class="nx">btapp</span><span class="p">});</span>
	<span class="nx">listener</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;btapp/label/all/nudges/torrent/all/*/file/all/*/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NudgeView</span><span class="p">({</span><span class="nx">model</span><span class="o">:</span> <span class="nx">file</span><span class="p">});</span>
		<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#nudge-list&quot;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">);</span>	
	<span class="p">});</span>
	</pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h2>Hookup UI for nudge creation (nudging)</h2>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#new-nudge&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Make sure that we're connected to the client...if not we should do some nice
messaging to the user explaining why we've failed</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;browseforfiles&#39;</span> <span class="k">in</span> <span class="nb">window</span><span class="p">.</span><span class="nx">btapp</span><span class="p">.</span><span class="nx">bt</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Pop up the torque file browser and when we get back the files the user has
selected, create individual torrents for each of them. Hopefully by now we've
worked out the falcon situation and the urls are already valid for use.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nb">window</span><span class="p">.</span><span class="nx">btapp</span><span class="p">.</span><span class="nx">bt</span><span class="p">.</span><span class="nx">browseforfiles</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">files</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>It might be nice to notify the user that we're nudging their files (creating torrents)...</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">files</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
				<span class="nb">window</span><span class="p">.</span><span class="nx">btapp</span><span class="p">.</span><span class="nx">bt</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{},</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">escape</span><span class="p">(</span><span class="nx">value</span><span class="p">)],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>and that we're now done...</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="p">},</span> <span class="s1">&#39;nudges&#39;</span><span class="p">,</span> <span class="s1">&#39;nudges&#39;</span><span class="p">);</span>
			<span class="p">});</span>
		<span class="p">});</span>
	<span class="p">});</span>
	</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h2>Set Falcon Settings</h2>

<p>Listen for the settings to arrive from the torrent client, then make sure
that it is connected to falcon to ensure that urls generated will be accessible.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nb">window</span><span class="p">.</span><span class="nx">btapp</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;add:settings&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">btapp</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;settings&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;webui.uconnect_username&#39;</span><span class="p">))</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">username</span> <span class="o">=</span> <span class="nx">generate_random_string</span><span class="p">();</span>
			<span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">generate_random_string</span><span class="p">();</span>
			<span class="nb">window</span><span class="p">.</span><span class="nx">btapp</span><span class="p">.</span><span class="nx">bt</span><span class="p">.</span><span class="nx">connect_remote</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{},</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">});</span>
<span class="p">});</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 